<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Catálogo Dual (GitHub / Local)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- Estilos Generales (sin cambios) --- */
        body { font-family: sans-serif; background-color: #f0f2f5; padding: 1.5rem; position: relative; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; font-size: 0.875rem; }
        input[type="text"], input[type="search"], input[type="url"], input[type="number"], textarea, select {
            width: 100%; padding: 0.65rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            margin-bottom: 1rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); font-size: 0.875rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        textarea { min-height: 60px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.6rem 1.1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; cursor: pointer; border: 1px solid transparent; focus:outline-none; focus:ring-2 focus:ring-offset-2; text-sm; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* --- Colores Botones (sin cambios) --- */
        .btn-blue { background-color: #3b82f6; color: white; border-color: #3b82f6; } .btn-blue:hover:not(:disabled) { background-color: #2563eb; }
        .btn-green { background-color: #10b981; color: white; border-color: #10b981; } .btn-green:hover:not(:disabled) { background-color: #059669; }
        .btn-red { background-color: #ef4444; color: white; border-color: #ef4444; } .btn-red:hover:not(:disabled) { background-color: #dc2626; }
        .btn-gray { background-color: #6b7280; color: white; border-color: #6b7280; } .btn-gray:hover:not(:disabled) { background-color: #4b5563; }
        .btn-indigo { background-color: #6366f1; color: white; border-color: #6366f1; } .btn-indigo:hover:not(:disabled) { background-color: #4f46e5; }
        .btn-yellow { background-color: #f59e0b; color: white; border-color: #f59e0b; } .btn-yellow:hover:not(:disabled) { background-color: #d97706; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }
        pre { background-color: #1f2937; color: #d1d5db; padding: 1rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.8rem; line-height: 1.4; margin-top: 1rem; max-height: 300px; }
        code { font-family: monospace; }
        .checkbox-label { display: flex; align-items: center; margin-bottom: 1rem; }
        .checkbox-label input { margin-right: 0.5rem; width: auto; height: 1rem; width: 1rem; }
        .feedback { min-height: 1.25rem; font-size: 0.875rem; margin-top: 0.5rem; }
        .section-divider { border-top: 1px solid #e5e7eb; margin-top: 1.5rem; margin-bottom: 1.5rem; }

        /* --- Estilos Catálogo Visual (modificado) --- */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.75rem; max-height: 350px; overflow-y: auto; padding: 0.5rem; background-color: #e5e7eb; border-radius: 0.375rem; border: 1px solid #d1d5db;}
        .catalog-item { background-color: white; border-radius: 0.375rem; overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; border: 2px solid transparent; position: relative; display: flex; flex-direction: column; } /* Flex column */
        .catalog-item:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .catalog-item.selected-for-edit { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); transform: scale(1.02); }
        .catalog-item.selected-for-subcatalog { border-color: #10b981; }
        .catalog-item img { display: block; width: 100%; height: 90px; object-fit: cover; }
        .catalog-item-name { font-size: 0.7rem; text-align: center; padding: 0.3rem 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #374151; background-color: rgba(255,255,255,0.9); line-height: 1.2; margin-top: auto; /* Push name to bottom */ }
        .catalog-placeholder { display: flex; align-items: center; justify-content: center; min-height: 150px; color: #6b7280; font-size: 0.875rem; text-align: center; border-radius: 0.375rem; background-color: #e5e7eb;}

        /* Botones dentro del item */
        .catalog-item-buttons { position: absolute; top: 4px; right: 4px; display: flex; flex-direction: column; gap: 3px; z-index: 10; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .catalog-item:hover .catalog-item-buttons { opacity: 1; }
        .catalog-item-btn { width: 22px; height: 22px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, opacity 0.2s; border: none; color: white; cursor: pointer; padding: 0; background-color: rgba(0, 0, 0, 0.5); }
        .catalog-item-btn:hover { background-color: rgba(0, 0, 0, 0.7); }
        .catalog-item-btn svg { width: 12px; height: 12px; }
        .catalog-item-btn.move-btn { background-color: rgba(99, 102, 241, 0.7); } /* Indigo */
        .catalog-item-btn.move-btn:hover { background-color: rgba(79, 70, 229, 0.9); }
        .catalog-item-btn.sub-add-btn { background-color: rgba(16, 185, 129, 0.7); } /* Green */
        .catalog-item-btn.sub-add-btn:hover { background-color: rgba(5, 150, 105, 0.9); }
        .catalog-item-btn.sub-remove-btn { background-color: rgba(239, 68, 68, 0.7); } /* Red */
        .catalog-item-btn.sub-remove-btn:hover { background-color: rgba(220, 38, 38, 0.9); }
        .catalog-item-btn:disabled { opacity: 0.3 !important; cursor: not-allowed !important; background-color: rgba(150, 150, 150, 0.5) !important; }

        .hidden-when-modal-open { display: none !important; } /* Mantener */

        /* --- Estilos Modal (sin cambios) --- */
        .modal-body { -webkit-overflow-scrolling: touch; }
        #editModal label { margin-bottom: 0.25rem; }
        #editModal input, #editModal textarea, #editModal select { margin-bottom: 0.75rem; }
        #editModal .checkbox-label { margin-bottom: 0.75rem; }
        #editModal pre { margin-top: 0.25rem; }

         /* --- Estilos Tooltip (sin cambios) --- */
        #productTooltip { }
        .catalog-item.tooltip-active { border-color: #a78bfa; }
        #productTooltip h4 { letter-spacing: 0.025em; }
        #productTooltip #tooltipPrice { text-shadow: 0 1px 3px rgba(74, 222, 128, 0.4); }
        #productTooltip #tooltipFeaturedBadge span { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Distinción Visual Opcional */
        #githubCatalogSection { border-left: 4px solid #3b82f6; padding-left: 1rem; }
        #localCatalogSection { border-left: 4px solid #10b981; padding-left: 1rem; }

    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto bg-white p-5 md:p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Editor Catálogo Dual (GitHub / Local)</h1>

        <!-- === SECCIÓN DE GESTIÓN GITHUB === -->
        <div class="mb-6 p-4 border border-blue-200 rounded-md bg-blue-50">
            <h2 class="text-lg font-semibold text-blue-800 mb-3">Gestión Catálogo GitHub</h2>
            <div class="flex flex-wrap gap-4 items-end">
                 <div class="flex-grow">
                    <p class="text-sm text-gray-600 mb-2">Carga el archivo JSON desde GitHub o guárdalo.</p>
                    <div class="flex space-x-2 items-center">
                        <button id="loadGithubBtn" class="btn btn-blue btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Cargar desde GitHub
                        </button>
                        <button id="saveGithubBtn" class="btn btn-green btn-sm">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                            Guardar Cambios en GitHub
                        </button>
                    </div>
                 </div>
                 <div class="flex-shrink-0">
                     <button id="clearAllBtn" class="btn btn-red btn-sm">Limpiar TODO (GitHub & Local)</button>
                 </div>
            </div>
             <p id="githubFeedback" class="feedback text-sm"></p>
        </div>

        <!-- === SECCIÓN DE GESTIÓN SUB-CATÁLOGOS (Vinculada a GitHub) === -->
        <div class="mb-6 p-4 border border-indigo-200 rounded-md bg-indigo-50">
            <h2 class="text-lg font-semibold text-indigo-800 mb-3">Gestión de Sub-Catálogos (del Catálogo GitHub)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                <div> <label for="subCatalogSelector">Sub-Catálogo Activo:</label> <select id="subCatalogSelector"><option value="">-- Ninguno --</option></select> </div>
                <div class="flex flex-wrap gap-2"> <button id="renameSubCatalogBtn" class="btn btn-yellow btn-sm flex-1 min-w-[100px]" disabled>Renombrar</button> <button id="deleteSubCatalogBtn" class="btn btn-red btn-sm flex-1 min-w-[100px]" disabled>Eliminar</button> </div>
                 <div> <label for="newSubCatalogName" class="block mb-1">Crear Nuevo Sub-Catálogo:</label> <div class="flex space-x-2"> <input type="text" id="newSubCatalogName" placeholder="Nombre único..." class="flex-grow mb-0 text-sm p-2"> <button id="createSubCatalogBtn" class="btn btn-indigo btn-sm flex-shrink-0">Crear</button> </div> <p id="subCatalogMgmtFeedback" class="feedback text-sm"></p> </div>
            </div>
        </div>

        <!-- === SECCIÓN AÑADIR AL CATÁLOGO LOCAL === -->
         <div class="mb-6 p-4 border border-green-200 rounded-md bg-green-50">
             <h2 class="text-lg font-semibold text-green-800 mb-3">Añadir Productos al Catálogo <span class="font-bold">Local</span></h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                 <div>
                    <label for="bulkUrls" class="font-semibold text-gray-700 mb-2">Añadir por URLs (una por línea):</label>
                    <textarea id="bulkUrls" placeholder="Pega aquí las URLs..." class="text-sm mb-2" rows="3"></textarea>
                    <button id="addBulkBtn" class="btn btn-green w-full">Añadir URLs al Local</button>
                    <p id="bulkFeedback" class="feedback text-sm text-center"></p>
                 </div>
                 <div class="text-center md:text-left pt-5">
                    <p class="text-gray-700 mb-2">O añadir uno nuevo manualmente:</p>
                    <button id="addNewManualBtn" class="btn btn-green">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Añadir Nuevo al Local
                    </button>
                    <p id="addManualFeedback" class="feedback text-sm text-center md:text-left"></p>
                 </div>
             </div>
         </div>

        <div class="section-divider"></div>

        <!-- === SECCIÓN VISUALIZACIÓN DUAL === -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Catálogo GitHub -->
            <div id="githubCatalogSection">
                <h2 class="text-xl font-semibold text-blue-700 mb-3">Catálogo GitHub</h2>
                <div class="mb-3"> <input type="search" id="githubCatalogSearch" placeholder="Buscar en GitHub Cat..." class="mb-0 text-sm p-2"> </div>
                 <p class="text-xs text-gray-500 mb-2">
                    <span class="inline-block w-3 h-3 bg-indigo-500 rounded-full mr-1"></span> Mover a Local.
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1 ml-2"></span> Añadir a Sub.
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span> Quitar de Sub. Clic <strong class="text-blue-600">[IMG]</strong>/Nombre: editar.
                 </p>
                <div id="githubCatalogGridContainer"> <div id="githubCatalogGrid" class="catalog-grid mb-6 hidden"></div> <div id="githubCatalogPlaceholder" class="catalog-placeholder">Carga el catálogo desde GitHub o añade productos desde el Local.</div> </div>
                 <div class="mt-4 text-center"> <h3 class="text-lg font-semibold text-gray-700 mb-2">Exportar Sub-Catálogo Activo</h3> <div class="flex flex-col sm:flex-row justify-center gap-4 max-w-md mx-auto"> <button id="copySubCatalogBtn" class="btn btn-green flex-1" disabled>Copiar JSON (Sub)</button> <button id="downloadSubCatalogBtn" class="btn btn-indigo flex-1" disabled>Descargar JSON (Sub)</button> </div> <p id="subCopyFeedback" class="feedback text-sm"></p> <p id="subDownloadFeedback" class="feedback text-sm"></p> </div>
            </div>

            <!-- Catálogo Local -->
            <div id="localCatalogSection">
                 <h2 class="text-xl font-semibold text-green-700 mb-3">Catálogo Local (Temporal/Staging)</h2>
                 <div class="mb-3"> <input type="search" id="localCatalogSearch" placeholder="Buscar en Local Cat..." class="mb-0 text-sm p-2"> </div>
                  <p class="text-xs text-gray-500 mb-2">
                     <span class="inline-block w-3 h-3 bg-indigo-500 rounded-full mr-1"></span> Mover a GitHub. Clic <strong class="text-blue-600">[IMG]</strong>/Nombre: editar.
                  </p>
                 <div id="localCatalogGridContainer"> <div id="localCatalogGrid" class="catalog-grid mb-6 hidden"></div> <div id="localCatalogPlaceholder" class="catalog-placeholder">Añade productos usando los botones de arriba o mueve desde GitHub.</div> </div>
                  <div class="mt-4 text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Exportar Catálogo Local Completo</h3>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 max-w-md mx-auto">
                        <button id="copyLocalCatalogBtn" class="btn btn-gray flex-1">Copiar JSON (Local)</button>
                        <button id="downloadLocalCatalogBtn" class="btn btn-gray flex-1">Descargar JSON (Local)</button>
                    </div>
                    <p id="copyLocalFeedback" class="feedback text-sm text-center"></p>
                    <p id="downloadLocalFeedback" class="feedback text-sm text-center"></p>
                 </div>
            </div>
        </div>

        <!-- No se necesita sección de exportación completa separada, se incluye en Local -->

    </div>

    <!-- === MODAL DE EDICIÓN (Sin cambios estructurales, lógica interna adaptada) === -->
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden opacity-0 transition-opacity duration-300 ease-in-out" aria-labelledby="modalTitle" role="dialog" aria-modal="true">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl transform transition-all duration-300 ease-in-out scale-95 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4 flex-shrink-0"> <h2 class="text-xl font-semibold text-gray-800" id="modalTitle">Editar Producto</h2> <button id="closeModalBtn" class="p-1 text-gray-400 hover:text-gray-700 rounded-full hover:bg-gray-100 transition-colors" aria-label="Cerrar modal"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div>
            <div class="modal-body overflow-y-auto pr-2 -mr-2 flex-grow"> <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3"> <div class="space-y-3"> <div> <label for="modalProductId">ID (Editable, debe ser único GLOBALMENTE):</label> <input type="number" id="modalProductId" min="1"> <p id="idFeedback" class="feedback text-xs text-red-600 -mt-2 mb-2"></p> </div> <div> <label for="modalProductName">Nombre:</label> <input type="text" id="modalProductName"> </div> <div> <label for="modalProductPrice">Precio (USD):</label> <input type="number" id="modalProductPrice" step="0.01" min="0"> </div> <div> <label for="modalProductImage">URL Imagen:</label> <input type="url" id="modalProductImage"> </div> <div class="checkbox-label pt-2"> <input type="checkbox" id="modalProductFeatured"> <label for="modalProductFeatured" class="mb-0 font-normal">¿Destacado?</label> </div> <div> <label for="modalProductCategory">Categoría:</label> <input type="text" id="modalProductCategory"> </div> </div> <div class="space-y-3"> <div> <label for="modalProductDescription">Descripción:</label> <textarea id="modalProductDescription" rows="4"></textarea> </div> <div> <label for="modalProductSpecifications">Especificaciones (una por línea):</label> <textarea id="modalProductSpecifications" rows="4"></textarea> </div> <div> <label>Previsualización JSON:</label> <pre class="max-h-40"><code id="modalJsonOutput">{ ... }</code></pre> </div> </div> </div> </div>
            <div class="border-t border-gray-200 pt-4 mt-4 flex flex-col sm:flex-row justify-between items-center gap-3 flex-shrink-0"> <div class="flex gap-3"> <button id="modalCopySingleBtn" class="btn btn-gray btn-sm">Copiar JSON</button> <button id="modalDeleteProductBtn" class="btn btn-red btn-sm">Eliminar Producto</button> </div> <p id="modalFeedback" class="feedback text-sm text-center flex-grow"></p> <button id="modalSaveChangesAndCloseBtn" class="btn btn-blue">Cerrar Editor</button> </div>
        </div>
    </div>

     <!-- === TOOLTIP (Sin cambios estructurales) === -->
    <div id="productTooltip" class="fixed hidden opacity-0 transition-opacity duration-200 ease-in-out z-[100] pointer-events-none"> <div class="bg-gray-900 bg-opacity-90 text-white rounded-lg shadow-2xl p-4 max-w-xs text-sm leading-relaxed backdrop-blur-sm border border-gray-700"> <h4 id="tooltipName" class="font-bold text-base mb-2 text-indigo-300"></h4> <p class="mb-2 flex justify-between items-center"> <span id="tooltipCategory" class="text-xs uppercase tracking-wider font-medium text-gray-400"></span> <span id="tooltipPrice" class="text-lg font-semibold text-green-400"></span> </p> <p id="tooltipDescription" class="text-gray-300 mb-3 text-xs"></p> <div id="tooltipSpecsContainer" class="mb-1"> <h5 class="text-xs font-semibold text-gray-400 mb-1">Especificaciones:</h5> <ul id="tooltipSpecsList" class="list-disc list-inside text-gray-300 text-xs space-y-0.5 pl-1"></ul> </div> <div id="tooltipFeaturedBadge" class="mt-3 hidden"> <span class="inline-block bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-0.5 rounded">✨ Destacado ✨</span> </div> </div> </div>

    <script>
        // --- GitHub Config ---
        const repoOwner = 'DonaLucia55';
        const repoName = 'Tienda';
        const filePath = 'Tiendacombos/1products.json';
        const branch = 'main';
        // ⚠️ Token personal de acceso (NECESARIO - ¡NO EXPONER EN PRODUCCIÓN PÚBLICA!)
        const token = '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'; // Reemplaza con tu token REAL

        // --- DOM Elements ---
        const loadGithubBtn = document.getElementById('loadGithubBtn');
        const saveGithubBtn = document.getElementById('saveGithubBtn');
        const githubFeedback = document.getElementById('githubFeedback');
        const clearAllBtn = document.getElementById('clearAllBtn');
        // Bulk add to Local
        const bulkUrls = document.getElementById('bulkUrls');
        const addBulkBtn = document.getElementById('addBulkBtn');
        const bulkFeedback = document.getElementById('bulkFeedback');
        // Add manual to Local
        const addNewManualBtn = document.getElementById('addNewManualBtn');
        const addManualFeedback = document.getElementById('addManualFeedback');
        // GitHub Catalog Area
        const githubCatalogGridContainer = document.getElementById('githubCatalogGridContainer');
        const githubCatalogGrid = document.getElementById('githubCatalogGrid');
        const githubCatalogPlaceholder = document.getElementById('githubCatalogPlaceholder');
        const githubCatalogSearch = document.getElementById('githubCatalogSearch');
        // Local Catalog Area
        const localCatalogGridContainer = document.getElementById('localCatalogGridContainer');
        const localCatalogGrid = document.getElementById('localCatalogGrid');
        const localCatalogPlaceholder = document.getElementById('localCatalogPlaceholder');
        const localCatalogSearch = document.getElementById('localCatalogSearch');
        const copyLocalCatalogBtn = document.getElementById('copyLocalCatalogBtn');
        const downloadLocalCatalogBtn = document.getElementById('downloadLocalCatalogBtn');
        const copyLocalFeedback = document.getElementById('copyLocalFeedback');
        const downloadLocalFeedback = document.getElementById('downloadLocalFeedback');
        // Sub-Catalog (tied to GitHub)
        const subCatalogSelector = document.getElementById('subCatalogSelector');
        const newSubCatalogNameInput = document.getElementById('newSubCatalogName');
        const createSubCatalogBtn = document.getElementById('createSubCatalogBtn');
        const renameSubCatalogBtn = document.getElementById('renameSubCatalogBtn');
        const deleteSubCatalogBtn = document.getElementById('deleteSubCatalogBtn');
        const subCatalogMgmtFeedback = document.getElementById('subCatalogMgmtFeedback');
        const activeSubCatalogNameDisplay = document.getElementById('activeSubCatalogNameDisplay'); // Re-check if used, maybe remove if sub-catalog display is implicit
        const copySubCatalogBtn = document.getElementById('copySubCatalogBtn');
        const downloadSubCatalogBtn = document.getElementById('downloadSubCatalogBtn');
        const subCopyFeedback = document.getElementById('subCopyFeedback');
        const subDownloadFeedback = document.getElementById('subDownloadFeedback');
        // Modal
        const editModal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalSaveChangesAndCloseBtn = document.getElementById('modalSaveChangesAndCloseBtn');
        const modalFeedback = document.getElementById('modalFeedback');
        const modalProductIdInput = document.getElementById('modalProductId');
        const idFeedback = document.getElementById('idFeedback');
        const modalProductNameInput = document.getElementById('modalProductName');
        const modalProductPriceInput = document.getElementById('modalProductPrice');
        const modalProductImageInput = document.getElementById('modalProductImage');
        const modalProductDescriptionInput = document.getElementById('modalProductDescription');
        const modalProductSpecificationsInput = document.getElementById('modalProductSpecifications');
        const modalProductFeaturedInput = document.getElementById('modalProductFeatured');
        const modalProductCategoryInput = document.getElementById('modalProductCategory');
        const modalJsonOutput = document.getElementById('modalJsonOutput');
        const modalCopySingleBtn = document.getElementById('modalCopySingleBtn');
        const modalDeleteProductBtn = document.getElementById('modalDeleteProductBtn');
        // Tooltip
        const productTooltip = document.getElementById('productTooltip');
        const tooltipName = document.getElementById('tooltipName');
        const tooltipCategory = document.getElementById('tooltipCategory');
        const tooltipPrice = document.getElementById('tooltipPrice');
        const tooltipDescription = document.getElementById('tooltipDescription');
        const tooltipSpecsContainer = document.getElementById('tooltipSpecsContainer');
        const tooltipSpecsList = document.getElementById('tooltipSpecsList');
        const tooltipFeaturedBadge = document.getElementById('tooltipFeaturedBadge');

        const modalOtherFormInputs = [ modalProductNameInput, modalProductPriceInput, modalProductImageInput, modalProductDescriptionInput, modalProductSpecificationsInput, modalProductFeaturedInput, modalProductCategoryInput ];

        // --- State ---
        let githubCatalogData = []; // Data from/for GitHub
        let localCatalogData = [];  // Data created/staged locally
        let subCatalogs = {};       // Sub-catalogs structure (operates on githubCatalogData IDs)
        let activeSubCatalogName = null;
        let selectedProductId = null;
        let selectedProductSource = null; // 'github' or 'local' - NEW state for modal context
        let originalProductIdBeforeEdit = null;
        let tooltipTimeout = null;
        let githubSearchTerm = '';
        let localSearchTerm = '';
        let searchDebounceTimeout = null;
        const LOCAL_STORAGE_KEY = 'visualProductCatalogEditor_Dual_v1'; // New key for dual structure

        // --- Utility Functions ---
        function showFeedback(element, message, isError = false, duration = 3000) { if (!element) return; element.textContent = message; element.classList.remove('text-red-600', 'text-green-600', 'text-blue-600'); element.classList.add(isError ? 'text-red-600' : 'text-green-600'); if (duration > 0) { setTimeout(() => { if (element.textContent === message) element.textContent = ''; }, duration); } }
        function getNextId() {
            const githubIds = githubCatalogData.map(p => p.id || 0);
            const localIds = localCatalogData.map(p => p.id || 0);
            const maxId = Math.max(0, ...githubIds, ...localIds);
            return maxId + 1;
        }
        function copyToClipboard(text, feedbackElement) { if (!text || text.trim() === '' || (text.startsWith('{') && text.includes('vacío'))) { showFeedback(feedbackElement, 'Nada que copiar.', true); return; } if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => showFeedback(feedbackElement, '¡Copiado!', false)).catch(err => { console.error('Error al copiar: ', err); showFeedback(feedbackElement, 'Error al copiar', true); }); } else { try { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); showFeedback(feedbackElement, '¡Copiado! (Fallback)', false); } catch (err) { console.error('Fallback: Error al copiar: ', err); showFeedback(feedbackElement, 'Error al copiar (Fallback)', true); } } }
        function findProductById(productId) {
             // Searches both catalogs, returns product and source
             let product = githubCatalogData.find(p => p.id === productId);
             if (product) return { product, source: 'github' };
             product = localCatalogData.find(p => p.id === productId);
             if (product) return { product, source: 'local' };
             return { product: null, source: null };
         }

        // --- Search Helper (Generic) ---
        function productMatchesSearch(product, searchTerm) {
            if (!product || !searchTerm) return true; // Show all if no search term
            const term = searchTerm; // Assumes already lowercased

            const nameMatch = (product.name || '').toLowerCase().includes(term);
            const descMatch = (product.description || '').toLowerCase().includes(term);
            const idMatch = String(product.id || '').includes(term);
            const urlMatch = (product.image || '').toLowerCase().includes(term);
            const specsMatch = (product.specifications || []).some(spec => (spec || '').toLowerCase().includes(term));
            const categoryMatch = (product.category || '').toLowerCase().includes(term);

            return nameMatch || descMatch || idMatch || urlMatch || specsMatch || categoryMatch;
        }

        // --- Core Logic: Data Saving/Loading (LocalStorage) ---
        function saveDataStructure() {
            const dataToSave = {
                githubData: githubCatalogData,
                localData: localCatalogData,
                subCatalogs: subCatalogs,
                activeSubCatalogName: activeSubCatalogName // Save active sub-catalog name
             };
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                console.log("Local data saved");
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showFeedback(githubFeedback, '¡ERROR GRAVE AL GUARDAR LOCALMENTE!', true, 0); // Use general feedback area
            }
        }
        function loadDataStructure() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const d = JSON.parse(storedData);
                    githubCatalogData = d.githubData || [];
                    localCatalogData = d.localData || [];
                    subCatalogs = d.subCatalogs || {};
                    // Restore active sub-catalog only if it still exists
                    activeSubCatalogName = (d.activeSubCatalogName && subCatalogs[d.activeSubCatalogName]) ? d.activeSubCatalogName : null;
                    console.log("Local data loaded");
                    return true;
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                // Reset state on error
                githubCatalogData = [];
                localCatalogData = [];
                subCatalogs = {};
                activeSubCatalogName = null;
                localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear corrupted data
            }
            return false;
        }

        // --- GitHub API Functions ---
        async function loadCatalogFromGithub() {
            if (!token || token.startsWith('ghp_') === false || token.length < 30) {
                 showFeedback(githubFeedback, 'Token de GitHub inválido o no configurado.', true, 5000);
                 return;
            }
            loadGithubBtn.disabled = true;
            loadGithubBtn.textContent = 'Cargando...';
            try {
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=${branch}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `Bearer ${token}`,
                        // No Cache-Control needed here, causes CORS issues
                    }
                });

                if (response.status === 404) {
                    // File not found, initialize with empty array
                    githubCatalogData = [];
                    showFeedback(githubFeedback, 'Archivo no encontrado en GitHub. Catálogo GitHub inicializado vacío.', false, 5000);
                } else if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                } else {
                    const data = await response.json();
                    if (!data.content) {
                        // Content might be empty if file is empty or it's a directory link
                        githubCatalogData = [];
                         showFeedback(githubFeedback, 'Contenido vacío o inválido en GitHub.', true, 5000);
                    } else {
                        const content = atob(data.content);
                        // Handle potential UTF-8 issues during parse
                        try {
                             githubCatalogData = JSON.parse(decodeURIComponent(escape(content)));
                             if (!Array.isArray(githubCatalogData)) {
                                 githubCatalogData = []; // Ensure it's an array
                                 throw new Error("El contenido JSON no es un array.");
                             }
                             showFeedback(githubFeedback, `Catálogo GitHub cargado (${githubCatalogData.length} productos).`, false);
                        } catch (parseError){
                             console.error("JSON Parse Error:", parseError);
                             showFeedback(githubFeedback, `Error al parsear JSON de GitHub: ${parseError.message}`, true, 5000);
                             githubCatalogData = []; // Reset on error
                        }
                    }
                }
                // IMPORTANT: After loading from GitHub, save the current state (including local data) to localStorage
                saveDataStructure();
                updateAllUI(); // Render both grids

            } catch (error) {
                console.error('Error al cargar de GitHub:', error);
                showFeedback(githubFeedback, `Error al cargar de GitHub: ${error.message}`, true, 5000);
                // Do not clear local data on GitHub load error
            } finally {
                 loadGithubBtn.disabled = false;
                 loadGithubBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Cargar desde GitHub`;
            }
        }

        async function saveCatalogToGithub() {
             if (!token || token.startsWith('ghp_') === false || token.length < 30) {
                 showFeedback(githubFeedback, 'Token de GitHub inválido o no configurado.', true, 5000);
                 return;
            }
            if (!confirm(`¿Seguro que quieres SOBREESCRIBIR el archivo "${filePath}" en GitHub con el contenido actual del Catálogo GitHub (${githubCatalogData.length} productos)?`)) {
                showFeedback(githubFeedback, 'Guardado cancelado.', true);
                return;
            }

            saveGithubBtn.disabled = true;
            saveGithubBtn.textContent = 'Guardando...';
            try {
                // 1. Get current file SHA
                let sha = null;
                try {
                    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=${branch}`, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const fileData = await response.json();
                        sha = fileData.sha;
                    } else if (response.status !== 404) { // Allow 404 for creating a new file
                        throw new Error(`Error al obtener SHA ${response.status}: ${response.statusText}`);
                    }
                     // If 404, sha remains null, which is fine for creation
                } catch (fetchShaError) {
                     throw new Error(`Error conectando para obtener SHA: ${fetchShaError.message}`);
                }


                // 2. Prepare content (ensure correct Base64 encoding for UTF-8)
                 const contentToSave = JSON.stringify(githubCatalogData, null, 4); // Use 4 spaces indent
                 const encodedContent = btoa(unescape(encodeURIComponent(contentToSave)));

                // 3. PUT request to update/create file
                const saveResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: `Actualización catálogo desde editor dual (${new Date().toISOString()})`,
                        content: encodedContent,
                        sha: sha, // Include SHA if updating, omit or null if creating
                        branch: branch
                    })
                });

                if (!saveResponse.ok) {
                    const errorDetails = await saveResponse.json();
                    throw new Error(`Error ${saveResponse.status}: ${saveResponse.statusText}. ${errorDetails.message || ''}`);
                }

                showFeedback(githubFeedback, '¡Catálogo guardado en GitHub con éxito!', false);
                // Optional: Reload from GitHub after saving to confirm, though usually not needed
                // loadCatalogFromGithub();

            } catch (error) {
                console.error('Error al guardar en GitHub:', error);
                showFeedback(githubFeedback, `Error al guardar en GitHub: ${error.message}`, true, 5000);
            } finally {
                 saveGithubBtn.disabled = false;
                 saveGithubBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg> Guardar Cambios en GitHub`;
            }
        }

        // --- Core Logic: Rendering ---
        function renderGithubCatalogGrid() {
            githubCatalogGrid.innerHTML = '';
            const searchTerm = githubSearchTerm; // Already lowercase
            const filteredProducts = githubCatalogData.filter(product => productMatchesSearch(product, searchTerm));

            const hasProducts = filteredProducts.length > 0;
            githubCatalogPlaceholder.classList.toggle('hidden', hasProducts);
            githubCatalogGrid.classList.toggle('hidden', !hasProducts);
            githubCatalogPlaceholder.textContent = searchTerm ? 'No hay productos que coincidan en GitHub.' : 'Catálogo GitHub vacío.';

            if (hasProducts) {
                filteredProducts.sort((a, b) => (a.id || 0) - (b.id || 0));
                const activeSubCatalogIds = activeSubCatalogName ? (subCatalogs[activeSubCatalogName] || []) : [];

                filteredProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.classList.add('catalog-item');
                    item.dataset.productId = product.id;
                    item.dataset.source = 'github'; // Identify source
                    item.classList.toggle('selected-for-subcatalog', activeSubCatalogIds.includes(product.id));

                    // --- Buttons Container ---
                    const btnContainer = document.createElement('div');
                    btnContainer.classList.add('catalog-item-buttons');

                    // 1. Move Button (to Local)
                    const moveBtn = document.createElement('button');
                    moveBtn.classList.add('catalog-item-btn', 'move-btn');
                    moveBtn.title = 'Mover a Catálogo Local';
                    moveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>`; // Arrow Right to Left style
                    moveBtn.addEventListener('click', (e) => { e.stopPropagation(); handleMoveProduct(product.id, 'github'); });
                    btnContainer.appendChild(moveBtn);

                    // 2. Sub-Catalog Buttons (Only if active sub-catalog exists)
                    if (activeSubCatalogName) {
                        const isAddedToSub = activeSubCatalogIds.includes(product.id);
                        const subToggleBtn = document.createElement('button');
                        subToggleBtn.classList.add('catalog-item-btn');
                        subToggleBtn.classList.toggle('sub-add-btn', !isAddedToSub);
                        subToggleBtn.classList.toggle('sub-remove-btn', isAddedToSub);
                        subToggleBtn.title = isAddedToSub ? 'Quitar del Sub-Catálogo Activo' : 'Añadir al Sub-Catálogo Activo';
                        subToggleBtn.innerHTML = isAddedToSub
                            ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>` // Minus
                            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>`; // Plus
                        subToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); handleToggleProductInSubCatalog(product.id); });
                        btnContainer.appendChild(subToggleBtn);
                    }
                    item.appendChild(btnContainer);
                    // --- End Buttons ---

                    const img = document.createElement('img');
                    img.src = product.image || 'https://via.placeholder.com/150?text=No+Image';
                    img.alt = product.name || 'Producto sin nombre';
                    img.loading = 'lazy';
                    img.onerror = (e) => { e.target.src = 'https://via.placeholder.com/150?text=Error'; };
                    // Make image clickable to edit
                    img.addEventListener('click', (e) => { e.stopPropagation(); openModal(product.id, 'github'); });
                    item.appendChild(img);

                    const nameDiv = document.createElement('div');
                    nameDiv.classList.add('catalog-item-name');
                    nameDiv.textContent = product.name || `ID: ${product.id}`;
                     // Make name clickable to edit
                    nameDiv.addEventListener('click', (e) => { e.stopPropagation(); openModal(product.id, 'github'); });
                    item.appendChild(nameDiv);

                    githubCatalogGrid.appendChild(item);
                });
            }
        }

        function renderLocalCatalogGrid() {
            localCatalogGrid.innerHTML = '';
            const searchTerm = localSearchTerm; // Already lowercase
            const filteredProducts = localCatalogData.filter(product => productMatchesSearch(product, searchTerm));

            const hasProducts = filteredProducts.length > 0;
            localCatalogPlaceholder.classList.toggle('hidden', hasProducts);
            localCatalogGrid.classList.toggle('hidden', !hasProducts);
            localCatalogPlaceholder.textContent = searchTerm ? 'No hay productos que coincidan en Local.' : 'Catálogo Local vacío.';

            if (hasProducts) {
                filteredProducts.sort((a, b) => (a.id || 0) - (b.id || 0));

                filteredProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.classList.add('catalog-item');
                    item.dataset.productId = product.id;
                    item.dataset.source = 'local'; // Identify source

                     // --- Buttons Container ---
                    const btnContainer = document.createElement('div');
                    btnContainer.classList.add('catalog-item-buttons');

                    // 1. Move Button (to GitHub)
                    const moveBtn = document.createElement('button');
                    moveBtn.classList.add('catalog-item-btn', 'move-btn');
                    moveBtn.title = 'Mover a Catálogo GitHub';
                    moveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.707-4.707a1 1 0 001.414-1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293z" clip-rule="evenodd" /></svg>`; // Arrow Left to Right style
                    moveBtn.addEventListener('click', (e) => { e.stopPropagation(); handleMoveProduct(product.id, 'local'); });
                    btnContainer.appendChild(moveBtn);

                    // No sub-catalog buttons for Local items
                    item.appendChild(btnContainer);
                     // --- End Buttons ---

                    const img = document.createElement('img');
                    img.src = product.image || 'https://via.placeholder.com/150?text=No+Image';
                    img.alt = product.name || 'Producto sin nombre';
                    img.loading = 'lazy';
                    img.onerror = (e) => { e.target.src = 'https://via.placeholder.com/150?text=Error'; };
                     // Make image clickable to edit
                    img.addEventListener('click', (e) => { e.stopPropagation(); openModal(product.id, 'local'); });
                    item.appendChild(img);

                    const nameDiv = document.createElement('div');
                    nameDiv.classList.add('catalog-item-name');
                    nameDiv.textContent = product.name || `ID: ${product.id}`;
                     // Make name clickable to edit
                    nameDiv.addEventListener('click', (e) => { e.stopPropagation(); openModal(product.id, 'local'); });
                    item.appendChild(nameDiv);

                    localCatalogGrid.appendChild(item);
                });
            }
        }

        // --- Sub-Catalog Specific ---
        function populateSubCatalogSelector() {
            const currentVal = subCatalogSelector.value;
            subCatalogSelector.innerHTML = '<option value="">-- Ninguno --</option>';
            Object.keys(subCatalogs).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                subCatalogSelector.appendChild(option);
            });
            // Restore selection if possible
            subCatalogSelector.value = activeSubCatalogName && subCatalogs[activeSubCatalogName] ? activeSubCatalogName : "";
            activeSubCatalogName = subCatalogSelector.value || null; // Update state
            // Enable/disable buttons based on selection
            const hasSelection = !!activeSubCatalogName;
            renameSubCatalogBtn.disabled = !hasSelection;
            deleteSubCatalogBtn.disabled = !hasSelection;
            copySubCatalogBtn.disabled = !hasSelection || !subCatalogs[activeSubCatalogName]?.length;
            downloadSubCatalogBtn.disabled = !hasSelection || !subCatalogs[activeSubCatalogName]?.length;
        }

        function handleToggleProductInSubCatalog(productId) {
            if (!activeSubCatalogName || !subCatalogs[activeSubCatalogName]) {
                showFeedback(subCatalogMgmtFeedback, "Selecciona un sub-catálogo activo primero.", true);
                return;
            }
            // Ensure the product actually exists in the GitHub catalog before toggling
            if (!githubCatalogData.some(p => p.id === productId)) {
                showFeedback(subCatalogMgmtFeedback, "Este producto no está en el catálogo GitHub.", true);
                return; // Safety check
            }

            const productIds = subCatalogs[activeSubCatalogName];
            const index = productIds.indexOf(productId);
            if (index > -1) {
                productIds.splice(index, 1); // Remove
            } else {
                productIds.push(productId); // Add
            }
            saveDataStructure(); // Save changes to subCatalogs
            renderGithubCatalogGrid(); // Re-render GitHub grid to show selection change
            // Update sub-catalog export button states
            copySubCatalogBtn.disabled = !activeSubCatalogName || !subCatalogs[activeSubCatalogName]?.length;
            downloadSubCatalogBtn.disabled = !activeSubCatalogName || !subCatalogs[activeSubCatalogName]?.length;
        }

        // --- Update UI (Combined) ---
        function updateAllUI() {
            renderGithubCatalogGrid();
            renderLocalCatalogGrid();
            populateSubCatalogSelector(); // Updates sub-catalog dropdown and related buttons
        }

        // --- Sub-Catalog Management (No major changes, operates on `subCatalogs` state) ---
        function handleCreateSubCatalog() { const name = newSubCatalogNameInput.value.trim(); if (!name) { showFeedback(subCatalogMgmtFeedback, "Introduce nombre.", true); return; } if (subCatalogs[name]) { showFeedback(subCatalogMgmtFeedback, `"${name}" ya existe.`, true); return; } subCatalogs[name] = []; activeSubCatalogName = name; newSubCatalogNameInput.value = ''; saveDataStructure(); updateAllUI(); showFeedback(subCatalogMgmtFeedback, `Sub "${name}" creado.`, false); }
        function handleRenameSubCatalog() { if (!activeSubCatalogName) return; const oldName = activeSubCatalogName; const newName = prompt(`Renombrar sub-catálogo "${oldName}" a:`, oldName); if (!newName || newName.trim() === '' || newName === oldName) { showFeedback(subCatalogMgmtFeedback, "Renombrado cancelado.", true); return; } const finalNewName = newName.trim(); if (subCatalogs[finalNewName]) { showFeedback(subCatalogMgmtFeedback, `"${finalNewName}" ya existe.`, true); return; } subCatalogs[finalNewName] = subCatalogs[oldName]; delete subCatalogs[oldName]; activeSubCatalogName = finalNewName; saveDataStructure(); updateAllUI(); showFeedback(subCatalogMgmtFeedback, `Renombrado a "${activeSubCatalogName}".`, false); }
        function handleDeleteSubCatalog() { if (!activeSubCatalogName) return; if (confirm(`¿Eliminar sub-catálogo "${activeSubCatalogName}"? (Los productos no se eliminarán del catálogo GitHub)`)) { const deletedName = activeSubCatalogName; delete subCatalogs[activeSubCatalogName]; activeSubCatalogName = null; // Reset active
            // Clear search term for sub-catalog if one was active, though it's less relevant now
            // subCatalogSearchTerm = ''; subCatalogSearch.value = '';
            saveDataStructure(); updateAllUI(); showFeedback(subCatalogMgmtFeedback, `Sub "${deletedName}" eliminado.`, true); } }
        function handleSubCatalogSelect() { activeSubCatalogName = subCatalogSelector.value || null;
            // activeSubCatalogNameDisplay.textContent = activeSubCatalogName || 'Ninguno Seleccionado'; // Remove or adapt if needed
             // Enable/disable buttons
            const hasSelection = !!activeSubCatalogName;
            renameSubCatalogBtn.disabled = !hasSelection;
            deleteSubCatalogBtn.disabled = !hasSelection;
            copySubCatalogBtn.disabled = !hasSelection || !subCatalogs[activeSubCatalogName]?.length;
            downloadSubCatalogBtn.disabled = !hasSelection || !subCatalogs[activeSubCatalogName]?.length;
            renderGithubCatalogGrid(); // Re-render GitHub grid to show selection borders and +/- buttons correctly
            // No need to save structure here, just changing the view state
        }

        // --- Product Movement ---
        function handleMoveProduct(productId, source) {
            let productToMove = null;
            let sourceArray = null;
            let destinationArray = null;
            let feedbackElement = null;
            let targetCatalogName = '';

            if (source === 'github') {
                sourceArray = githubCatalogData;
                destinationArray = localCatalogData;
                feedbackElement = githubFeedback; // Show feedback near source
                targetCatalogName = 'Local';
            } else if (source === 'local') {
                sourceArray = localCatalogData;
                destinationArray = githubCatalogData;
                feedbackElement = bulkFeedback; // Show feedback near local section controls
                targetCatalogName = 'GitHub';
            } else {
                console.error("Invalid source for move:", source);
                return;
            }

            const productIndex = sourceArray.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showFeedback(feedbackElement, `Error: Producto ${productId} no encontrado en origen.`, true);
                return;
            }

            // Remove from source
            [productToMove] = sourceArray.splice(productIndex, 1);

            // Add to destination
            destinationArray.push(productToMove);

            // If moving FROM GitHub, remove from any sub-catalogs
            if (source === 'github') {
                 for (const catName in subCatalogs) {
                     subCatalogs[catName] = subCatalogs[catName].filter(id => id !== productId);
                 }
                 // Update sub-catalog export button states as item count might change
                 copySubCatalogBtn.disabled = !activeSubCatalogName || !subCatalogs[activeSubCatalogName]?.length;
                 downloadSubCatalogBtn.disabled = !activeSubCatalogName || !subCatalogs[activeSubCatalogName]?.length;
            }

            saveDataStructure(); // Persist changes
            updateAllUI(); // Re-render both grids
            showFeedback(feedbackElement, `Producto ${productToMove.name || productId} movido a Catálogo ${targetCatalogName}.`, false);
        }


        // --- Modal Functions (Adapted for Source Context) ---
        function openModal(productId, source) {
             const { product } = findProductById(productId); // Use helper
             if (!product) {
                 console.error(`Product ${productId} not found in any catalog.`);
                 return;
             }

             originalProductIdBeforeEdit = productId;
             selectedProductId = productId;
             selectedProductSource = source; // Store the source ('github' or 'local')

             modalTitle.textContent = `Editar (${source === 'github' ? 'GitHub' : 'Local'}): ${product.name || `ID ${productId}`}`;

             populateModalForm(product);
             idFeedback.textContent = '';
             // Hide +/- and move buttons on grid items while modal is open
             document.querySelectorAll('.catalog-item-buttons').forEach(btnDiv => {
                 btnDiv.classList.add('hidden-when-modal-open');
             });

             editModal.classList.remove('hidden');
             requestAnimationFrame(() => {
                 editModal.classList.remove('opacity-0', 'scale-95');
                 editModal.classList.add('opacity-100', 'scale-100');
                 // Check if it looks like a newly added placeholder in LOCAL catalog
                  const isPlaceholderLocal = source === 'local' && product.name === `Nuevo Producto ${productId}` && product.image.includes('placeholder');
                  if (isPlaceholderLocal) {
                      modalProductNameInput.focus();
                      modalProductNameInput.select();
                  }
             });

             // Highlight item in the correct grid
             document.querySelectorAll('.catalog-item.selected-for-edit').forEach(el => el.classList.remove('selected-for-edit'));
             const gridSelector = source === 'github' ? '#githubCatalogGrid' : '#localCatalogGrid';
             document.querySelectorAll(`${gridSelector} .catalog-item[data-product-id="${productId}"]`).forEach(el => {
                 el.classList.add('selected-for-edit');
             });
        }

        function closeModal() {
            editModal.classList.remove('opacity-100', 'scale-100');
            editModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                document.querySelectorAll('.catalog-item.selected-for-edit').forEach(el => el.classList.remove('selected-for-edit'));
                // Reset modal state
                selectedProductId = null;
                selectedProductSource = null;
                originalProductIdBeforeEdit = null;
                modalFeedback.textContent = '';
                // Show grid buttons again
                 document.querySelectorAll('.catalog-item-buttons').forEach(btnDiv => {
                    btnDiv.classList.remove('hidden-when-modal-open');
                });
            }, 300);
        }

        function populateModalForm(product) { /* No changes needed here */ if (!product) return; modalProductIdInput.value = product.id || ''; modalProductNameInput.value = product.name || ''; modalProductPriceInput.value = product.price !== undefined ? product.price.toFixed(2) : ''; modalProductImageInput.value = product.image || ''; modalProductDescriptionInput.value = product.description || ''; modalProductSpecificationsInput.value = (product.specifications || []).join('\n'); modalProductFeaturedInput.checked = product.featured || false; modalProductCategoryInput.value = product.category || ''; updateModalJsonOutput(); } // updateModalJsonOutput needs context now

        function updateModalJsonOutput() {
            // Needs selectedProductId AND selectedProductSource
            if (selectedProductId === null || selectedProductSource === null) {
                modalJsonOutput.textContent = '...';
                return;
            }
            const sourceArray = selectedProductSource === 'github' ? githubCatalogData : localCatalogData;
            const product = sourceArray.find(p => p.id === selectedProductId);
            modalJsonOutput.textContent = product ? JSON.stringify(product, null, 4) : '{ // Error: Producto no encontrado en origen }';
        }

        function updateProductDataFromModalForm() {
            // Updates the product in the correct array based on selectedProductSource
            if (selectedProductId === null || selectedProductSource === null) return;

            const sourceArray = selectedProductSource === 'github' ? githubCatalogData : localCatalogData;
            const productIndex = sourceArray.findIndex(p => p.id === selectedProductId);

            if (productIndex === -1) {
                console.error(`Autosave fail: ID ${selectedProductId} not found in ${selectedProductSource} catalog.`);
                showFeedback(modalFeedback, "Error: Producto no encontrado para guardar.", true);
                return;
            }

            const specificationsArray = modalProductSpecificationsInput.value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const updatedProduct = {
                ...sourceArray[productIndex], // Preserve existing fields
                name: modalProductNameInput.value.trim(),
                price: parseFloat(modalProductPriceInput.value) || 0.00,
                image: modalProductImageInput.value.trim(),
                description: modalProductDescriptionInput.value.trim(),
                specifications: specificationsArray,
                featured: modalProductFeaturedInput.checked,
                category: modalProductCategoryInput.value.trim()
            };

            // Update the array directly
            sourceArray[productIndex] = updatedProduct;

            // Update the specific grid item visually
            const gridSelector = selectedProductSource === 'github' ? '#githubCatalogGrid' : '#localCatalogGrid';
            document.querySelectorAll(`${gridSelector} .catalog-item[data-product-id="${selectedProductId}"]`).forEach(gridItem => {
                if (gridItem) {
                    const nameEl = gridItem.querySelector('.catalog-item-name');
                    const imgEl = gridItem.querySelector('img');
                    if (nameEl) nameEl.textContent = updatedProduct.name || `ID: ${updatedProduct.id}`;
                    if (imgEl && imgEl.src !== updatedProduct.image) {
                        imgEl.src = updatedProduct.image || 'https://via.placeholder.com/150?text=No+Image';
                    }
                    // Note: Sub-catalog border handled by render function, not needed here
                }
            });

            updateModalJsonOutput(); // Update JSON preview in modal
            saveDataStructure(); // Persist changes to localStorage
            // No need to re-render entire grid on modal change, just the item
        }

        function handleIdChange() {
            // ID changes are complex in a dual system, ensure GLOBAL uniqueness
             idFeedback.textContent = '';
             if (selectedProductId === null || originalProductIdBeforeEdit === null || selectedProductSource === null) {
                 return false;
             }

             const sourceArray = selectedProductSource === 'github' ? githubCatalogData : localCatalogData;
             const otherArray = selectedProductSource === 'github' ? localCatalogData : githubCatalogData;

             const newIdValue = modalProductIdInput.value.trim();
             const newId = parseInt(newIdValue);

             // Basic validation
             if (isNaN(newId) || newId <= 0 || newIdValue !== String(newId)) {
                 showFeedback(idFeedback, "ID inválido (debe ser número entero positivo).", true, 0);
                 return false;
             }

             // No change? Do nothing.
             if (newId === originalProductIdBeforeEdit) {
                 selectedProductId = originalProductIdBeforeEdit; // Ensure state consistency
                 idFeedback.textContent = '';
                 updateModalJsonOutput();
                 return true;
             }

             // Check GLOBAL uniqueness (against both catalogs)
             if (sourceArray.some(p => p.id === newId) || otherArray.some(p => p.id === newId)) {
                 showFeedback(idFeedback, `ID ${newId} ya existe en uno de los catálogos.`, true, 0);
                 return false;
             }

             // Find the product in the source array
             const productIndex = sourceArray.findIndex(p => p.id === originalProductIdBeforeEdit);
             if (productIndex === -1) {
                 showFeedback(idFeedback, "Error interno: Producto original no encontrado.", true, 0);
                 return false;
             }

             const oldId = originalProductIdBeforeEdit;

             // Update ID in the product object
             sourceArray[productIndex].id = newId;

             // If it was in the GitHub catalog, update sub-catalogs
             if (selectedProductSource === 'github') {
                 for (const catName in subCatalogs) {
                     const idIndex = subCatalogs[catName].indexOf(oldId);
                     if (idIndex > -1) {
                         subCatalogs[catName][idIndex] = newId;
                     }
                 }
             }

             // Update modal state
             selectedProductId = newId;
             originalProductIdBeforeEdit = newId; // The "original" ID for subsequent checks *within this modal session* is now the new ID
             modalTitle.textContent = `Editar (${selectedProductSource === 'github' ? 'GitHub' : 'Local'}): ${sourceArray[productIndex].name || `ID ${newId}`}`;

             // Save and update UI
             saveDataStructure();
             updateModalJsonOutput();
             updateAllUI(); // Need full UI update to reflect ID changes in grids/sub-catalogs

             showFeedback(idFeedback, `ID actualizado a ${newId}.`, false, 3000);
             return true;
        }

        function deleteSelectedProduct() {
            // Deletes from the source catalog where the modal was opened
             if (selectedProductId === null || selectedProductSource === null) {
                 showFeedback(modalFeedback, "Ningún producto seleccionado para eliminar.", true);
                 return;
             }

             const sourceArray = selectedProductSource === 'github' ? githubCatalogData : localCatalogData;
             const productIndex = sourceArray.findIndex(p => p.id === selectedProductId);

             if (productIndex === -1) {
                 showFeedback(modalFeedback, `Error: Producto ${selectedProductId} no encontrado en Catálogo ${selectedProductSource}.`, true);
                 return;
             }

             const product = sourceArray[productIndex];
             const productName = product?.name || `ID ${selectedProductId}`;
             const catalogName = selectedProductSource === 'github' ? 'GitHub' : 'Local';

             if (confirm(`¿Eliminar "${productName}" del Catálogo ${catalogName}? ${selectedProductSource === 'github' ? '(También se quitará de TODOS los sub-catálogos)' : ''}`)) {
                 const deletedId = selectedProductId;

                 // Remove from the source array
                 sourceArray.splice(productIndex, 1);

                 // If deleted from GitHub catalog, also remove from all sub-catalogs
                 if (selectedProductSource === 'github') {
                     for (const catName in subCatalogs) {
                         subCatalogs[catName] = subCatalogs[catName].filter(id => id !== deletedId);
                     }
                 }

                 saveDataStructure();
                 updateAllUI(); // Update grids and sub-catalog view
                 showFeedback(modalFeedback, `"${productName}" eliminado del Catálogo ${catalogName}.`, false, 4000);
                 closeModal(); // Close modal after deletion
             }
        }

        // --- Tooltip Functions (Adapted for Source Context) ---
         function populateTooltip(product) { /* No changes needed */ if (!product) return; tooltipName.textContent = product.name || 'Sin Nombre'; tooltipCategory.textContent = product.category || 'Sin Categoría'; tooltipPrice.textContent = product.price !== undefined ? `$${product.price.toFixed(2)}` : 'N/A'; tooltipDescription.textContent = product.description || ''; tooltipDescription.classList.toggle('hidden', !product.description); tooltipSpecsList.innerHTML = ''; if (product.specifications && product.specifications.length > 0) { tooltipSpecsContainer.classList.remove('hidden'); product.specifications.forEach(spec => { const li = document.createElement('li'); li.textContent = spec; tooltipSpecsList.appendChild(li); }); } else { tooltipSpecsContainer.classList.add('hidden'); } tooltipFeaturedBadge.classList.toggle('hidden', !product.featured); }
         function positionTooltip(event) { /* No changes needed */ const tooltipRect = productTooltip.getBoundingClientRect(); const scrollX = window.scrollX; const scrollY = window.scrollY; let x = event.pageX + 15; let y = event.pageY + 15; if (x + tooltipRect.width > window.innerWidth + scrollX - 10) { x = event.pageX - tooltipRect.width - 15; } if (y + tooltipRect.height > window.innerHeight + scrollY - 10) { y = event.pageY - tooltipRect.height - 15; } if (x < scrollX + 10) { x = scrollX + 10; } if (y < scrollY + 10) { y = scrollY + 10; } productTooltip.style.left = `${x}px`; productTooltip.style.top = `${y}px`; }
         function showTooltip(productId, event, source) {
             clearTimeout(tooltipTimeout);
             const { product } = findProductById(productId); // Use helper
             if (!product) return;

             const gridSelector = source === 'github' ? '#githubCatalogGrid' : '#localCatalogGrid';
             const gridItem = document.querySelector(`${gridSelector} .catalog-item[data-product-id="${productId}"]`);
             if (gridItem) gridItem.classList.add('tooltip-active');

             populateTooltip(product);
             productTooltip.classList.remove('hidden');
             requestAnimationFrame(() => {
                 positionTooltip(event);
                 productTooltip.classList.remove('opacity-0');
                 productTooltip.classList.add('opacity-100');
             });
         }
         function hideTooltip(productId, source) {
             clearTimeout(tooltipTimeout);
             if (productId && source) {
                 const gridSelector = source === 'github' ? '#githubCatalogGrid' : '#localCatalogGrid';
                 const gridItem = document.querySelector(`${gridSelector} .catalog-item[data-product-id="${productId}"]`);
                 if (gridItem) gridItem.classList.remove('tooltip-active');
             } else {
                 // Hide any active tooltip if called without specifics
                 document.querySelectorAll('.catalog-item.tooltip-active').forEach(el => el.classList.remove('tooltip-active'));
             }
             productTooltip.classList.remove('opacity-100');
             productTooltip.classList.add('opacity-0');
             tooltipTimeout = setTimeout(() => {
                 productTooltip.classList.add('hidden');
             }, 200); // Delay hiding slightly
         }

        // --- Event Handlers ---
        // Note: File input now removed, replaced by GitHub load button
        function handleBulkAdd() { // Adds to LOCAL catalog
             const urls = bulkUrls.value.split('\n').map(url => url.trim()).filter(url => url.length > 5 && (url.startsWith('http') || url.startsWith('data:image')));
             if (urls.length === 0) {
                 showFeedback(bulkFeedback, "No URLs válidas encontradas.", true);
                 return;
             }
             let count = 0;
             urls.forEach(url => {
                 const newId = getNextId(); // Get unique ID across both catalogs
                 const newProduct = { id: newId, name: `Nuevo ${newId}`, price: 0.00, image: url, description: "", specifications: [], featured: false, category: "" };
                 localCatalogData.push(newProduct); // Add to LOCAL data
                 count++;
             });
             if (count > 0) {
                 saveDataStructure(); // Save updated local data
                 renderLocalCatalogGrid(); // Update only the local grid
                 bulkUrls.value = '';
                 showFeedback(bulkFeedback, `${count} producto(s) añadidos al Catálogo Local.`);
             } else {
                 showFeedback(bulkFeedback, "No se añadieron productos.", true);
             }
         }

         function handleAddManualProduct() { // Adds to LOCAL catalog
            const newId = getNextId();
            const newProduct = {
                id: newId,
                name: `Nuevo Producto ${newId}`,
                price: 0.00,
                image: 'https://via.placeholder.com/150/EEEEEE/AAAAAA?text=Editar+Imagen',
                description: "", specifications: [], featured: false, category: ""
            };
            localCatalogData.push(newProduct); // Add to LOCAL data
            saveDataStructure();
            renderLocalCatalogGrid(); // Update local grid

             // Scroll and highlight
             requestAnimationFrame(() => {
                const newItemElement = localCatalogGrid.querySelector(`.catalog-item[data-product-id="${newId}"]`);
                if (newItemElement && localCatalogGridContainer) {
                    const containerRect = localCatalogGridContainer.getBoundingClientRect();
                    const itemRect = newItemElement.getBoundingClientRect();
                    const scrollOffset = itemRect.top - containerRect.top + localCatalogGridContainer.scrollTop - 10;
                    localCatalogGridContainer.scrollTop = scrollOffset;
                    newItemElement.style.transition = 'box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out';
                    newItemElement.style.borderColor = '#10b981';
                    newItemElement.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.5)';
                    setTimeout(() => {
                       newItemElement.style.borderColor = ''; newItemElement.style.boxShadow = '';
                       setTimeout(() => { newItemElement.style.transition = ''; }, 300);
                    }, 1500);
                }
             });

            openModal(newId, 'local'); // Open modal for editing, specifying source
            showFeedback(addManualFeedback, `Producto ${newId} añadido a Local. Edita detalles.`, false);
         }

        function handleCopyLocalCatalog() { if (!localCatalogData || localCatalogData.length === 0) { showFeedback(copyLocalFeedback, 'Catálogo Local vacío.', true); return; } copyToClipboard(JSON.stringify(localCatalogData, null, 4), copyLocalFeedback); }
        function handleDownloadLocalCatalog() { if (!localCatalogData || localCatalogData.length === 0) { showFeedback(downloadLocalFeedback, 'Catálogo Local vacío.', true); return; } try { const filename = "products_local.json"; const jsonStr = JSON.stringify(localCatalogData, null, 4); const blob = new Blob([jsonStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showFeedback(downloadLocalFeedback, `"${filename}" descargado.`); } catch (error) { console.error("Error descarga local:", error); showFeedback(downloadLocalFeedback, 'Error descarga.', true); } }
        function handleCopySubCatalog() { /* No changes needed, operates on subCatalogs */ if (!activeSubCatalogName || !subCatalogs[activeSubCatalogName] || subCatalogs[activeSubCatalogName].length === 0) { showFeedback(subCopyFeedback, 'Sub-catálogo vacío o no seleccionado.', true); return; } const ids = subCatalogs[activeSubCatalogName]; const data = ids.map(id => githubCatalogData.find(p => p.id === id)).filter(Boolean); copyToClipboard(JSON.stringify(data, null, 4), subCopyFeedback); }
        function handleDownloadSubCatalog() { /* No changes needed, operates on subCatalogs */ if (!activeSubCatalogName || !subCatalogs[activeSubCatalogName] || subCatalogs[activeSubCatalogName].length === 0) { showFeedback(subDownloadFeedback, 'Sub-catálogo vacío o no seleccionado.', true); return; } try { const ids = subCatalogs[activeSubCatalogName]; const data = ids.map(id => githubCatalogData.find(p => p.id === id)).filter(Boolean); const filename = `sub_${activeSubCatalogName.replace(/\W+/g, '_')}.json`; const jsonStr = JSON.stringify(data, null, 4); const blob = new Blob([jsonStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showFeedback(subDownloadFeedback, `"${filename}" descargado.`); } catch (error) { console.error("Error descarga sub:", error); showFeedback(subDownloadFeedback, 'Error descarga.', true); } }

        function handleClearAll() {
            if (confirm("¿BORRAR TODO? Esto eliminará los datos de AMBOS catálogos (GitHub y Local) y los sub-catálogos guardados localmente. ¡Esta acción no se puede deshacer!")) {
                githubCatalogData = [];
                localCatalogData = [];
                subCatalogs = {};
                activeSubCatalogName = null;
                selectedProductId = null;
                selectedProductSource = null;
                originalProductIdBeforeEdit = null;
                githubSearchTerm = ''; githubCatalogSearch.value = '';
                localSearchTerm = ''; localCatalogSearch.value = '';
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                updateAllUI();
                closeModal(); // Ensure modal is closed if open
                showFeedback(githubFeedback, "Todos los datos locales eliminados.", true, 5000);
            }
        }

         // --- Debounced Search Handler ---
        function handleSearchInput(event) {
            clearTimeout(searchDebounceTimeout);
            const inputElement = event.target;
            const searchTerm = inputElement.value.toLowerCase();

            searchDebounceTimeout = setTimeout(() => {
                if (inputElement.id === 'githubCatalogSearch') {
                    githubSearchTerm = searchTerm;
                    renderGithubCatalogGrid(); // Render only GitHub grid
                } else if (inputElement.id === 'localCatalogSearch') {
                    localSearchTerm = searchTerm;
                    renderLocalCatalogGrid(); // Render only Local grid
                }
            }, 300);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // GitHub Management
            loadGithubBtn.addEventListener('click', loadCatalogFromGithub);
            saveGithubBtn.addEventListener('click', saveCatalogToGithub);
            clearAllBtn.addEventListener('click', handleClearAll);

            // Local Catalog Management
            addBulkBtn.addEventListener('click', handleBulkAdd);
            addNewManualBtn.addEventListener('click', handleAddManualProduct);
            copyLocalCatalogBtn.addEventListener('click', handleCopyLocalCatalog);
            downloadLocalCatalogBtn.addEventListener('click', handleDownloadLocalCatalog);
            localCatalogSearch.addEventListener('input', handleSearchInput);

            // GitHub Catalog Search
            githubCatalogSearch.addEventListener('input', handleSearchInput);

            // Sub-Catálogos (Tied to GitHub View)
            subCatalogSelector.addEventListener('change', handleSubCatalogSelect);
            createSubCatalogBtn.addEventListener('click', handleCreateSubCatalog);
            renameSubCatalogBtn.addEventListener('click', handleRenameSubCatalog);
            deleteSubCatalogBtn.addEventListener('click', handleDeleteSubCatalog);
            copySubCatalogBtn.addEventListener('click', handleCopySubCatalog);
            downloadSubCatalogBtn.addEventListener('click', handleDownloadSubCatalog);

            // Modal
            closeModalBtn.addEventListener('click', closeModal);
            modalSaveChangesAndCloseBtn.addEventListener('click', closeModal);
            modalDeleteProductBtn.addEventListener('click', deleteSelectedProduct);
            modalCopySingleBtn.addEventListener('click', () => { copyToClipboard(modalJsonOutput.textContent, modalFeedback); });
            modalProductIdInput.addEventListener('blur', handleIdChange); // ID change on blur
            editModal.addEventListener('click', (event) => { if (event.target === editModal) { closeModal(); } });
            // Auto-save modal changes (except ID)
             modalOtherFormInputs.forEach(input => {
                 const eventType = input.type === 'checkbox' ? 'change' : 'input';
                 input.addEventListener(eventType, updateProductDataFromModalForm);
             });


            // Tooltip (Event Delegation on both grids)
             const setupTooltipListeners = (gridElement) => {
                 gridElement.addEventListener('mouseover', (event) => {
                    const item = event.target.closest('.catalog-item');
                    // Ensure not hovering over internal buttons
                    if (item && !event.target.closest('.catalog-item-btn')) {
                         const id = parseInt(item.dataset.productId);
                         const source = item.dataset.source; // 'github' or 'local'
                         if (!isNaN(id) && source) {
                             clearTimeout(tooltipTimeout);
                             tooltipTimeout = setTimeout(() => { showTooltip(id, event, source); }, 150);
                         }
                     } else {
                         clearTimeout(tooltipTimeout);
                         hideTooltip(null, null); // Hide any active tooltip
                     }
                 });
                 gridElement.addEventListener('mouseout', (event) => {
                     const item = event.target.closest('.catalog-item');
                     if (item) {
                         const id = parseInt(item.dataset.productId);
                         const source = item.dataset.source;
                         if (!isNaN(id) && source) {
                             clearTimeout(tooltipTimeout);
                             hideTooltip(id, source); // Hide specific tooltip
                         }
                     }
                 });
                 gridElement.addEventListener('mousemove', (event) => {
                     // Reposition only if tooltip is visible and over an item (not buttons)
                     if (!productTooltip.classList.contains('hidden') && event.target.closest('.catalog-item') && !event.target.closest('.catalog-item-btn')) {
                         positionTooltip(event);
                     } else if (!event.target.closest('.catalog-item')) {
                         // Hide if mouse moved out of any item
                         clearTimeout(tooltipTimeout);
                         hideTooltip(null, null);
                     }
                 });
                 // Click listeners for editing are now added dynamically within the render functions
             };

            setupTooltipListeners(githubCatalogGrid);
            setupTooltipListeners(localCatalogGrid);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if (loadDataStructure()) { // Load from localStorage first
                showFeedback(githubFeedback, "Datos locales cargados.", false, 4000);
            } else {
                 showFeedback(githubFeedback, "No se encontraron datos locales. Carga desde GitHub o empieza a añadir localmente.", false, 5000);
            }
            updateAllUI(); // Render initial state from loaded data or empty arrays
            setupEventListeners();

            // Optional: Automatically try to load from GitHub on page load if token is present
            // if (token && token.length > 30) {
            //     loadCatalogFromGithub();
            // }
        });

    </script>

</body>
</html>